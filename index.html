<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Practice Log Viewer — Ben Chan | benchantech.com</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #fafafa; color: #222; margin: 0; padding: 1rem; }
    header { text-align: center; padding: 1rem 0; border-bottom: 1px solid #ddd; }
    h1 { margin: 0; font-size: 1.6rem; }
    #settings { max-width: 650px; margin: 1rem auto; background: #fff; padding: 1rem; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    label { display: block; margin-top: 0.5rem; font-size: 0.9rem; }
    input, select { width: 100%; padding: 0.4rem; margin-top: 0.2rem; border: 1px solid #ccc; border-radius: 4px;}
    .slug-options { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.2rem; }
    .slug-options input[type="color"] { width: 40px; padding: 0; }
    .slug-options input[data-slug-xp] { width: 60px; }
    button { margin-top: 1rem; padding: 0.5rem 1rem; border: none; background: #0077cc; color: white;
      border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    button:hover { background: #005fa3; }
    #chartContainer { max-width: 800px; margin: 2rem auto; background: #fff; padding: 1rem; border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);}
    #toggleSettings { display: block; margin: 1rem auto; background: #444; }
    .clear-btn { margin-top: 0.3rem; background: #999; }
    .settings-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; }
    #shareSettings { background:#28a745; }
    #xpBar { height: 24px; display: flex; margin-top: 1rem; border-radius: 6px; overflow: hidden; position: relative; }
    #xpBarLabels { display: flex; height: 24px; margin-top: 2px; font-size: 0.8rem; }
    #xpBarLabels div { text-align: center; color: #000; font-weight: bold; display: flex; align-items: center; justify-content: center; }
    #streakInfo { margin-top: 1rem; font-size: 0.9rem; text-align: center; }
    footer { text-align: center; margin-top: 2rem; font-size: 0.8rem; color: #666; }
    .chart-actions { display: flex; justify-content: flex-end; max-width: 800px; margin: 0 auto; padding: 0 1rem; }
    #refreshVisible { margin-bottom: 0.5rem; background: #28a745; }
    #refreshVisible:hover { background: #218838; }
  </style>
</head>
<body>
  <header>
    <h1>Practice Log Viewer</h1>
  </header>

  <button id="toggleSettings">Show Settings</button>

  <div id="settings" style="display:none;">
    <label>GitHub Username:
      <input type="text" id="username">
    </label>
    <label>Public Repo Name:
      <input type="text" id="repo">
    </label>
    <label>Practice Log Slugs (comma-separated):
      <input type="text" id="slugs">
    </label>
    <label>Start Date:
      <input type="date" id="startDate">
    </label>
    <label>End Date (optional):
      <input type="date" id="endDate">
    </label>
    <button class="clear-btn" id="clearEndDate">Clear End Date</button>
    <button class="clear-btn" id="clearCache">Clear Cache</button>

    <label>Chart Type:
      <select id="chartType">
        <option value="line">Line</option>
        <option value="bar">Bar</option>
        <option value="stackedBar">Stacked Bar</option>
        <option value="pie">Pie</option>
        <option value="radar">Radar</option>
        <option value="polarArea">Polar Area</option>
      </select>
    </label>

    <div id="slugSettings"></div>

    <div class="settings-actions">
      <button id="updateSettings">Update</button>
      <button id="shareSettings">Share</button>
    </div>
  </div>

  <div class="chart-actions">
    <button id="refreshVisible">Refresh Visible Days</button>
  </div>
  <div id="chartContainer">
    <canvas id="practiceChart"></canvas>
    <div id="xpBar"></div>
    <div id="xpBarLabels"></div>
    <div id="streakInfo"></div>
  </div>

  <footer>
    <p>Free tool by <strong>Ben Chan</strong> — <a href="https://benchantech.com" target="_blank">benchantech.com</a></p>
    <p style="font-size:0.7rem;">Licensed CC BY 4.0 — Attribution required if redistributed.</p>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log("%cPractice Log Viewer built by Ben Chan | https://benchantech.com", "color: #0077cc; font-weight: bold;");

      const LS_KEYS = ['username', 'repo', 'slugs', 'startDate', 'endDate', 'chartType'];
      const colorKey = slug => `color_${slug}`;
      const emojiKey = slug => `emoji_${slug}`;
      const xpKey = slug => `xp_${slug}`;
      const cacheKey = (slug,date)=>`logcache_${slug}_${date}`;

      function loadSettings() {
        let hasData = true;
        LS_KEYS.forEach(k => {
          const val = localStorage.getItem(k);
          if (val) document.getElementById(k).value = val;
          else if (k !== 'endDate') hasData = false;
        });
        renderSlugOptions();
        return hasData;
      }

      function saveSettings() {
        LS_KEYS.forEach(k => {
          const val = document.getElementById(k).value.trim();
          if (val || k === 'endDate') localStorage.setItem(k, val);
        });
        saveSlugOptions();
      }

      function renderSlugOptions() {
        const slugContainer = document.getElementById('slugSettings');
        slugContainer.innerHTML = '';
        const slugs = (document.getElementById('slugs').value || '').split(',').map(s => s.trim()).filter(Boolean);
        slugs.forEach(slug => {
          const colorVal = localStorage.getItem(colorKey(slug)) || '#0077cc';
          const emojiVal = localStorage.getItem(emojiKey(slug)) || '';
          const xpVal = localStorage.getItem(xpKey(slug)) || '1';
          const div = document.createElement('div');
          div.className = 'slug-options';
          div.innerHTML = `
            <span>${slug}</span>
            <input type="color" data-slug="${slug}" value="${colorVal}">
            <input type="text" placeholder="Color" data-slug-color="${slug}" value="${colorVal}">
            <input type="text" placeholder="Emoji" maxlength="2" data-slug-emoji="${slug}" value="${emojiVal}">
            <input type="number" placeholder="XP/min" min="0" step="1" data-slug-xp="${slug}" value="${xpVal}">
          `;
          slugContainer.appendChild(div);
        });
      }

      function saveSlugOptions() {
        document.querySelectorAll('input[data-slug]').forEach(inp => {
          localStorage.setItem(colorKey(inp.dataset.slug), inp.value);
        });
        document.querySelectorAll('input[data-slug-color]').forEach(inp => {
          if (inp.value.trim()) localStorage.setItem(colorKey(inp.dataset.slugColor), inp.value.trim());
        });
        document.querySelectorAll('input[data-slug-emoji]').forEach(inp => {
          localStorage.setItem(emojiKey(inp.dataset.slugEmoji), inp.value.trim());
        });
        document.querySelectorAll('input[data-slug-xp]').forEach(inp => {
          localStorage.setItem(xpKey(inp.dataset.slugXp), inp.value.trim() || '1');
        });
      }

      function toggleSettings(show) {
        const settings = document.getElementById('settings');
        const btn = document.getElementById('toggleSettings');
        if (show) {
          settings.style.display = 'block';
          btn.textContent = 'Hide Settings';
        } else {
          settings.style.display = 'none';
          btn.textContent = 'Show Settings';
        }
      }

      document.getElementById('toggleSettings').addEventListener('click', () => {
        toggleSettings(document.getElementById('settings').style.display === 'none');
      });

      document.getElementById('updateSettings').addEventListener('click', () => {
        saveSettings();
        toggleSettings(false);
        refreshData();
      });

      document.getElementById('clearEndDate').addEventListener('click', () => {
        document.getElementById('endDate').value = '';
        localStorage.removeItem('endDate');
      });

      document.getElementById('clearCache').addEventListener('click', () => {
        if (confirm("This will reset all practice logs and you will have to set the Start Date back to the beginning to recover lost data.  Proceed?")) {
          Object.keys(localStorage).forEach(k=>{
            if (k.startsWith('logcache_')) localStorage.removeItem(k);
          });
          alert('Cache cleared!');
        }
      });

      document.getElementById('refreshVisible').addEventListener('click', async () => {
        await refreshData(true);
      });

      document.getElementById('shareSettings').addEventListener('click',()=>{
        const encoded = encodeSettings();
        const url = `${location.origin}${location.pathname}?s=${encoded}`;
        navigator.clipboard.writeText(url).then(()=>alert('Shareable link copied!'));
      });

      // --- existing refreshData, drawChart, calculateXPandStreaks, etc. (same as before, unchanged except for forceRefetch support) ---

      // initialize
      const fromQuery = loadFromQuery();
      const hasSettings = loadSettings();
      toggleSettings(!hasSettings);
      if (hasSettings || fromQuery) refreshData();
    });
  </script>
</body>
</html>
